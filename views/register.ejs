<%- include("./partials/head.ejs")%>

    <body>
        <%- include("./partials/navbar.ejs")%>
            <div class="page-container">
                <div class="register-container">
                    <h2>Registruj korisnika</h2>
                    <form action="/user/register" method="post">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" name="password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Confirm Password</label>
                            <input type="password" id="confirm-password" name="confirm-password" required>
                            <p id="password-match-message" style="color: red;"></p>
                        </div>
                        <div class="form-group" id="ptt-field">
                            <div id="ptt-inner">
                                <label for="ptt">PTT</label>
                                <input type="number" id="ptt" name="ptt" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="role">Role</label>
                            <select id="role" name="role">
                                <option value="klijent">Klijent</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Sacuvaj</button>
                    </form>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Korisnik</th>
                            <th>PTT</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if(users.length> 0) { %>
                            <% var rowNumber=1; %>
                                <% users.forEach(user=> { %>
                                    <tr>
                                        <td>
                                            <%= rowNumber %>
                                        </td>
                                        <td>
                                            <%= user.username %>(<%= user.role %>)
                                        </td>
                                        <td>
                                            <%= user.ptt %>
                                        </td>
                                        <td>
                                            <a class="delete" data-doc="<%= user._id %>" href="#">
                                                <img src="/public/trashcan.svg" alt="Trashcan Icon"></a>
                                        </td>
                                    </tr>
                                    <% rowNumber++; %>
                                        <% }); %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="5">Nema klijenata za prikaz!</td>
                                                </tr>
                                                <% } %>
                    </tbody>
                </table>
            </div>


            <script>
                const passwordInput = document.getElementById('password');
                const confirmInput = document.getElementById('confirm-password');
                const message = document.getElementById('password-match-message');
                const form = document.querySelector('form');

                function validatePassword() {
                    if (passwordInput.value !== confirmInput.value) {
                        message.textContent = 'Passwords do not match.';
                        form.addEventListener('submit', preventSubmit);
                    } else {
                        message.textContent = '';
                        form.removeEventListener('submit', preventSubmit);
                    }
                }

                function preventSubmit(event) {
                    event.preventDefault();
                    message.textContent = 'Passwords do not match. Please make sure your passwords match.';
                }

                passwordInput.addEventListener('input', validatePassword);
                confirmInput.addEventListener('input', validatePassword);

                const deleteButtons = document.querySelectorAll('a.delete');

                deleteButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const docId = button.getAttribute('data-doc');
                        const endpoint = `/user/${docId}`;

                        fetch(endpoint, {
                            method: 'DELETE',
                        })
                            .then(response => response.json())
                            .then(data => window.location.href = data.redirect)
                            .catch(err => console.log(err));
                    });
                });



                const roleSelect = document.getElementById('role');
                const pttInput = document.getElementById('ptt');
                const pttInner = document.getElementById('ptt-inner');

                function togglePTTField() {
                    const selectedRole = roleSelect.value;

                    if (selectedRole === 'klijent') {
                        pttInput.required = true; // Keep the 'required' attribute for "klijent"
                        pttInput.style.display = 'block'; // Show the PTT field for "klijent"
                        pttInner.style.display = 'block';
                    } else {
                        pttInput.required = false; // Remove the 'required' attribute for other roles
                        pttInput.style.display = 'none'; // Hide the PTT field for other roles
                        pttInner.style.display = 'none';
                    }
                }

                // Initially set the 'required' attribute based on the default selected role
                togglePTTField();

                roleSelect.addEventListener('change', togglePTTField);
            </script>

    </body>

    </html>
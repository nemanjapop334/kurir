<%- include("./partials/head2.ejs")%>

    <body>
        <%- include("./partials/navbar.ejs")%>
            <h2>Lista posiljaka</h2>
            <p><a href="/paket/deleteall">Izbrisi listu</a></p>

            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Klijent</th>
                        <th>Adresa</th>
                        <th>Telefon</th>
                        <th>Cena</th>
                        <th>PTT</th>
                        <th>Datum</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <% if(pakets.length> 0) { %>
                        <% var rowNumber=1; %>
                            <% pakets.forEach(paket=> { %>
                                <tr>
                                    <td>
                                        <%= rowNumber %>
                                    </td>
                                    <td>
                                        <%= paket.klijent %>
                                    </td>
                                    <td>
                                        <%= paket.adresa %>
                                    </td>
                                    <td>
                                        <%= paket.telefon %>
                                    </td>
                                    <td>
                                        <%= paket.cena %>
                                    </td>
                                    <td>
                                        <%= paket.ptt %>
                                    </td>
                                    <td>
                                        <%= new Date(paket.datum).toLocaleDateString('sr-RS') %>
                                    </td>
                                    <td>
                                        <a class="delete" data-doc="<%= paket._id %>" href="#">
                                            <img src="/public/trashcan.svg" alt="Trashcan Icon"></a>
                                    </td>
                                </tr>
                                <% rowNumber++; %>
                                    <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="5">Nema unetih posiljaka za prikaz</td>
                                            </tr>
                                            <% } %>
                </tbody>
            </table>
            <script>
                const deleteButtons = document.querySelectorAll('a.delete');

                deleteButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const docId = button.getAttribute('data-doc');
                        const endpoint = `/paket/${docId}`;

                        fetch(endpoint, {
                            method: 'DELETE',
                        })
                            .then(response => response.json())
                            .then(data => window.location.href = data.redirect)
                            .catch(err => console.log(err));
                    });
                });

                const tableBody = document.querySelector('tbody');
                const rows = Array.from(tableBody.querySelectorAll('tr'));

                // Sort rows by paket.klijent, and then by paket.adresa
                rows.sort((a, b) => {
                    const klijentA = a.querySelectorAll('td')[1].textContent.toLowerCase();
                    const klijentB = b.querySelectorAll('td')[1].textContent.toLowerCase();
                    const adresaA = a.querySelectorAll('td')[3].textContent.toLowerCase();
                    const adresaB = b.querySelectorAll('td')[3].textContent.toLowerCase();

                    if (klijentA !== klijentB) {
                        return klijentA.localeCompare(klijentB);
                    } else {
                        return adresaA.localeCompare(adresaB);
                    }
                });

                // Reorder the rows in the table based on the sorted rows
                rows.forEach((row, index) => {
                    tableBody.appendChild(row);
                    row.querySelector('td').textContent = index + 1;
                });
            </script>
            <%- include("./partials/footer.ejs") %>
    </body>

    </html>